<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- jQuery -->
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

      <!-- Atlassian User Interface (AUI) -->
      <link rel="stylesheet" href="//aui-cdn.atlassian.com/aui-adg/5.7.0/css/aui.css" media="all">
      <script src="//aui-cdn.atlassian.com/aui-adg/5.7.0/js/aui.js"></script>

      <!-- Helper Javascript lib -->
      <script src="utils.js" type="text/javascript"></script>
      <script src="https://d3js.org/d3.v3.min.js"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.6/Chart.min.js"></script>

      <script>
        $(document).ready(function () {
           var allJS = Utils.getBaseUrl() + '/all.js';
           $.getScript(allJS, function () {});
        });
      </script>

      <style>
        main {
          margin: auto;
          width: 50%;
          padding: 10px;
        }
        h5 {
          display: inline;
          padding: 12px;
        }
        canvas {
          width: 100%;
          height: 100%;
          margin: 0px;
        }
        /*body {
          margin: 0px;
          padding: 0px:
        }*/
      </style>

   </head>
   <body id="main-body">
     <main>
       <canvas id="chart" width = "425" height = "500"></canvas>
       <div style="text-align:center;">
         <div id="filter-labels">

         </div>
         <h4>Total Cases: 0</h4>
         <input type="radio" id="phase" name="filter" onclick="check(this.value)" value="Phase">Phase
         <input type="radio" id="priority" name="filter" onclick="check(this.value)" value="Priority">Priority
         <input type="radio" id="device" name="filter" onclick="check(this.value)" value="Device">Device
         <!--button id="primary-action-button" class="aui-button aui-button-primary">Generate Graph</button-->
       </div>
     </main>
     <script type="text/javascript">
       var chart;

       var phaseRadio = document.getElementById("phase");
       phaseRadio.checked = true;
       check("Phase");

       function check(filter) {
         selection = filter;
         console.log('selection: ' + selection);

         var filterArr = [];
         var dataArr = [];
         var data;
         var title;

         $.ajax('https://sheetsu.com/apis/v1.0/ff05010c60f3')
          .done(function(data) {
            console.log(data);
            var i;
            var len = data.length;
            var total = 0;
            data = data;
            var totalArr = [];
            var passArr = [];
            var failArr = [];
            var blockedArr = [];
            var wipArr = [];
            var unexecutedArr = [];
            var count = 0;
            var start = 0;
            var end = 0;
            for (i = 0, len; i < len; ++i) {

              if (data[i].Title.indexOf(selection) >= 0) {
                start = i;
                break;
                /*count++;
                title = data[i].Title;
                count = i;
                while(title.indexOf(selection) >= 0){
                  count++;
                  console.log(title);
                  filterArr.push(data[count].Filter + ': ' + data[count].total);

                  passArr.push(data[count].Pass);
                  failArr.push(data[count].Fail);
                  blockedArr.push(data[count].Blocked);
                  wipArr.push(data[count].WIP);
                  unexecutedArr.push(data[i].Unexecuted);

                  var parsed = parseInt(data[count].total);
                  totalArr.push(data[count].total);
                  total = parsed + total;

                }*/
              }
            }

            console.log('start: ' + start);
            var j = start;
            for(j; j < data.length; j++){
              if(j == start){
                title = data[j].Title;
              } else {
                if(data[j].Filter == ""){
                  break;
                } else {
                  filterArr.push(data[j].Filter + ': ' + data[j].total);

                  passArr.push(data[j].Pass);
                  failArr.push(data[j].Fail);
                  blockedArr.push(data[j].Blocked);
                  wipArr.push(data[j].WIP);
                  unexecutedArr.push(data[j].Unexecuted);

                  var parsed = parseInt(data[j].total);
                  totalArr.push(data[j].total);
                  total = parsed + total;
                }
              }
            }


            $('h4').text('Total Cases: ' + total);

            barData = {
              labels: filterArr,
              datasets: [
                {
                  label: 'Pass',
                  backgroundColor: 'rgba(117,176,0,1)',
                  data: passArr
                },
                {
                  label: 'Fail',
                  backgroundColor: 'rgba(204,51,0,1)',
                  data: failArr
                },
                {
                  label: 'Blocked',
                  backgroundColor: 'rgba(102,147,176,1)',
                  data: blockedArr
                },
                {
                  label: 'WIP',
                  backgroundColor: 'rgba(242,176,0,1)',
                  data: wipArr
                },
                {
                  label: 'Unexecuted',
                  backgroundColor: 'rgba(160,160,160,1)',
                  data: unexecutedArr
                }
              ]
            }

            var context = document.getElementById('chart').getContext('2d');
            if (chart && typeof chart === 'object') {
              chart.destroy();
            }

            chart = new Chart(context, {
              type: 'bar',
              data: barData,
              options: {
                title: {
                  display: true,
                  text: title,
                  fontSize: 22
                },
                responsive: false
              }
            });

          //console.log(filterArr);

          /*var barData = {
            labels: ['Pass', 'Fail', 'Blocked', 'WIP', 'Unexecuted'],
            datasets: [
              {
                label: filterArr[0],
                backgroundColor: 'rgba(0,153,51)',
                //data: [data[1].Pass, data[1].Fail, data[1].Blocked, data[1].WIP, data[1].Unexecuted]
                data: dataArr[0]
              },
              {
                label: filterArr[1],
                backgroundColor: 'rgba(0,153,51)',
                //data: [data[1].Pass, data[1].Fail, data[1].Blocked, data[1].WIP, data[1].Unexecuted]
                data: dataArr[1]
              },
              {
                label: filterArr[2],
                backgroundColor: 'rgba(0,153,51)',
                //data: [data[1].Pass, data[1].Fail, data[1].Blocked, data[1].WIP, data[1].Unexecuted]
                data: dataArr[2]
              }
            ]
          }*/


          });
       }

     </script>
   </body>
</html>
